# Создание кластера k3s

## Схема

```null
Public network (dhcp)                Internet (+ Host)
____________________________________/
|     |     |     |     |     |
S1    S2    S3    A1    A2    A3
|.1   |.2   |.3   |.4   |.5   |.6
⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺⎺\ 
Private network                      192.168.0.0/24
```

## Подготовка кластера

1. Каждая машина должна иметь не менее 4 ГБ RAM, 2 CPU и 20 ГБ HDD.

1. Задать имена:

```bash
hostnamectl set-hostname <name>
```

1. Настроить сеть.

1. На каждой машине в `/etc/hosts` создать запись об S1.

1. ⚠️ **Сделать снапшоты ВСЕХ машин.**

1. Инициализировать кластер на S1:

```bash
apt install -y curl

curl -fL https://get.k3s.io | K3S_TOKEN=SECRET sh -s - server --cluster-init
```

1. Подключить к кластеру S2 и S3 (если они есть):

```bash
apt install -y curl

curl -sfL https://get.k3s.io | K3S_TOKEN=SECRET sh -s - server --server https://192.168.0.1:6443
```

1. Подключить ВСЕ агенты:

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.0.1:6443 K3S_TOKEN=SECRET sh -s -
```

1. Проверить статус:

```bash
kubectl get nodes
```

Если все ОК, то ⚠️ **сделать снапшоты ВСЕХ машин**, иначе, возможно, потребуется откатиться к предыдущему снапшоту.

1. На S1 установить SSH-сервер.

1. На хостовую машину установить VS Code для дальнейшего удобства. Можно вместо этого использовать любые другие средства.

1. Проверить подключение к S1 через VS Code.

Нажать `Ctrl + Shift + P`, ввести в появившемся окне `Remote-SSH: Connect to Host...`, далее указать адрес машины, к которой нужно подключиться с указанием пользователя (например, `user@192.168.0.1`). Далее будет предложено ввести пароль от пользователя `user` на удаленной машине. Если все ОК, то будет доступен домашний каталог пользователя `user`, а в нижней части экрана на вкладке `Terminal` можно вводить команды на удаленной машине. Если все ОК, то можно дополнительно сделать снапшоты.

1. Настройка **автодополнения** на той node, откуда будет осуществляться управление:

```bash
echo "source <(kubectl completion bash)" >> ~/.bashrc && source ~/.bashrc
```

## Удаление

На сервере: `/usr/local/bin/k3s-uninstall.sh`.

На агенте: `/usr/local/bin/k3s-agent-uninstall.sh`.
